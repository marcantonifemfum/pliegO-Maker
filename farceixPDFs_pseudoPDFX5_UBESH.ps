%!
%% És una alternativa a... inocula.ps (incrusta via Reference XObjects, un PDF dins un altre)
%% A partir del GS 9.55 s'han documentat unes funcions de PostScript que ja existien en versions anteriors de l'interpret...
%% https://ghostscript.readthedocs.io/en/latest/Language.html#scripting-the-pdf-interpreter
%% la manera com ho expliquen a «Scripting the PDF interpreter» dóna la sensació que no es podien cridar en versions anteriors
%% cosa que hem desmentit gràcies a documentar el què encara ens sembla un Bug o una mala documentació del manual
%% https://bugs.ghostscript.com/show_bug.cgi?id=706268 ..Ken Sharp s'excusa davant una asimetia en el comportament del nou
%% intèrpret (escrit en C) vs l'antic escrit en PostScript, doncs la realitat ens diu que en versions anteriors a la 9.55
%% podem utilitzar aquestes funcions que es documenten i a partir de la 9.55 hem de fer servir el gatell -dNEWPDF=false
%% de fet aquest gatell és transparent si el fem servir en versions més antigues, via línia de comanda, i no actua
%% llavors forcem l'ús de l'itèrpret PS en comptes de nou en C, que és on hi tindrem el problema a partir de la v.10.# doncs
%% ja anuncien que l'eliminaran (fins la versió 10.0 encara rutlla) ...si no corregeixen els comportaments d'aquestes crides
%% dins el nou intèrpret (que ara no funcionen bé), haurem d'optar per incorporar CaLi2CoPi a l'execució amb pliegO'Maker

%% Què fem doncs?
%% fiquem una determinada pàgina d'un PDF dins una altra determinada pàgina d'un altre PDF que generem 'on the fly'
%% via PDF scripting, consultant abans un seguit de coses:
%% 01: quantes planes té el PDF a imposar? (en condiciona el comportament segons l'nUp triat)
%% 02: la plana duu /CropBox? (aquest paràmetre resulta crític doncs ens ensorra tota l'estratègia del llançat)
%% 03: si la plana no duu /CropBox seguim sense més entrebancs
%% 04: si la plana duu /CropBox el comparem amb el /MediaBox, si són idèntics eliminem /CropBox i seguim sense més entrebancs
%% 05: si /CropBox i /MediaBox no són idèntics, capturem les dades del /CropBox i l'eliminem, el Bbox capturat en servirà per:
%% 06: afegir un clip complementari al de la pàgina del llançat per tal s'imposi corregint l'escalat del retall del crop
%% 07: la plana duu /TrimBox? (aquest paràmetre no és crític doncs només informa del tall de guillotina)
%% 08: si a plana duu /TrimBox (i també /CropBox o no) podríem forçar fer treballar sempre /TrimBox amb el clip complementari
%% 09: sigui com sigui /TrimBox també l'hauríem d'eliminar doncs ens condiciona, com la resta d'arees (/ArtBox /BleedBox)
%% 10: uns valors particulars de les pàgines del llançat que ara ja no juguen cap paper dins la plana sencera de l'nUp
%% 11: fent referència al punt 01 seria senzill contemplar el cas de quan el PDF a imposar té 2 pàgines dins 1 mateixa plana

%% A data d'avui (desembre de 2022) aquesta funcionalitat d'intercanvi de dades que recull la ISO 15930 PDF/X-5 (pdf 1.6)
%% https://www.iso.org/standard/55844.html ...a nivell de producte final, només coneixem l'Adobe Acrobat (Reader o Professional)
%% que contempli com a detectables els anomenats... Reference XObjects ...dins un programari d'ús per la indústria
%% cap dels PDF Viewers que s'han implementat darrerament per als navegadors (Firefox/Chrome) ni a Linux, ho contempla
%% El projecte pliegOS a través de pliegO'Maker implementa de manera bàsica Reference XObjects amb l'algoritme... inocula.ps

%% Amb el codi que segueix, arribem als mateixos resultats que els plantejats per la filosofia dels Reference XObjects, però
%% sense la necessitat de fer servir un programari de visualització (PDF Viewer) que ho activi de forma remota, doncs el
%% resultat de la crida, pàgina a pàgina, ja queda completament integrada dins el nou PDF resultant

%% crides al GS segons la versió:
%% anteriors a 9.55
%% ?
%% de 9.55 fins a 10.0
%% ?

%%REpublica hem integrat FemFum_CaLi2CoPi_042.ps per tal d'eliminar (de moment a sac) la clau /CropBox
%% i filtrar PDFs amb signatura digital o amb encriptacio de seguretat
%%UBESH hem de millorar l'anàlisi i comportament

noNULL  %% pinta el contingut de pàgina?
{ %% anellem el codi sencer perquè no és aleatori

%%Dos mètodes de lectura
 false
 /MdL exch def

 MdL
 {  %% diversos fitxers d'1 sola pàgina separats
  [  %% array de paths als fitxers PDF per ordre
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj1.pdf)  %% 0
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj2.pdf)  %% 1
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj3.pdf)  %% 2
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj4.pdf)  %% 3
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj5.pdf)  %% 4
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj6.pdf)  %% 5
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj7_pla.pdf)  %% 6
%   (/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/Ncj8.pdf)  %% 7

%%Conte Gerard
%% llibret 1
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/cimDreta_photo_5852728411179563623_y.pdf)  %% 1
%% en blanc (false a r1:2 de %% 4 4vUpHV)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/portada_photo_5852728411179563622_y.pdf)  %% 3
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/1_photo_5852728411179563620_y.pdf)  %% 4
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/2_photo_5852728411179563620_y.pdf)  %% 5
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/3_photo_5852728411179563621_y.pdf)  %% 6
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/4_photo_5852728411179563621_y.pdf)  %% 7
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/5_photo_5852728411179563619_y.pdf)  %% 8

%% llibret 2
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/6_photo_5852728411179563619_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/7_photo_5852728411179563618_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/8_photo_5852728411179563618_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/9_photo_5852728411179563617_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/10_photo_5852728411179563617_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/11_photo_5852728411179563616_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/12_photo_5852728411179563616_y.pdf)
(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/13_photo_5852728411179563615_y.pdf)

%% llibret 3
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/14_photo_5852728411179563615_y.pdf)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/15_photo_5852728411179563614_y.pdf)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/16_photo_5852728411179563614_y.pdf)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/17_photo_5852728411179563613_y.pdf)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/18_photo_5852728411179563613_y.pdf)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/contra_photo_5852728411179563612_y.pdf)
%% en blanc (false a r6:7 de %% 4 4vUpHV)
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/Gerard/cimEsquerra_photo_5852728411179563623_y.pdf)

  ]  %% fem el llançat 1 per 1
  Npgn cvx exec 1 sub
  %iSeq 1 sub
  %iPln
  get
  /pedeefa exch def

  %1% deixa una instància oberta a memòria sense cap objecte a l'stack que permet anar interrogant
  pedeefa (r) file dup /elF exch def runpdfbegin  %% cal tancar-la amb runpdfend al final

  %3% inicialitzem per intervenir dins l'estructura del pdf, afegint noves branques de dades, com la dels formularis
  /Context1 .PDFInit def
  pedeefa Context1 .PDFFile

  Context1 .PDFInfo

%% pot haver-hi problemes amb les transparències?
%/UsesTransparency
%/PageHasTransparency true put

%/NumPages get /pAimposar exch def  %% nombre de pàgines a imposar del PDF a incrustar
  %% aquí podem treure conclusions de si l' M2, pel pliegOS escollit, podrem fer el llançat de totes les pàgines
  %% si en quedaran de buides a pliegOS (EP! n'hi pot haver de forçades) o si no les podrem imposar totes
 }
 {  %% un sol fitxer de nUp x 2 pàgines
  iSeq 1 eq  %% només 1 cop al principi
  {  %% aquí dins és crític què i com ho posem
   %0% adreça al pdf a incrustar

%%EP cal saber quina bruixa o paràmetre del PDF fa que l'escala no rutlli com cal
   %(/Users/femfum/515-Book_Manuscript-1184-2-10-20221020.pdf)
   %(/Users/femfum/Downloads/Origin_of_Patterning_LU_OPT.pdf)
   %(/Users/femfum/Tipografia_organica.pdf)
   %(/Users/femfum/SOS-pirineus_WEB_V3.pdf)
   %(/Users/femfum/Ma_et_al-2017-Nature.pdf)
   %(/Users/femfum/Future_of_Text_Book_2020.pdf)
   %(/Users/femfum/festesDelVent2022elPlaDeSantaMaria.pdf)
   %(/Users/femfum/els-secrets-de-l-ecoedicio_123120.pdf)
   %(/Users/femfum/Albert-Forns-Chuck-Palahunik-a-Barcelona.pdf)
   %(/Users/femfum/PP-Gramatica-dels-noms-propis.pdf)


%%Corregit /CropBox
   %(/Users/femfum/extracte_mossegar-la-poma_pla_aZero.pdf)
   %(/Users/femfum/extracte_mossegar-la-poma_foraCropBox_pla.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/ACJ_pliego_test_1a_pla_foraCropBox.pdf)

%%De l'Enric, falla també la imposició en algun punt, amb fitxers vecorials teòricament molt simples
%%Però hem vist que NO HI TE RES A VEURE el codi del tou dels stream/endstream dins els /Contents de pàgina
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/ACJ_pliego_test_1a_pla.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/ACJ_pliego_test_1a_pla_aZero.pdf)
%%Aquest va bé perquè és tot imatge
%(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/separatSenabre/ACJ_pliego_test_1b_pngs.pdf)

%%Aquests van bé!
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/testMediaBox.pdf)
   %(/Users/femfum/Downloads/quantum_theory.pdf)
   %(/Users/femfum/01.NMG_TESI.pdf)
   %(/Users/femfum/iva_maslac.pdf)
   %(/Users/femfum/rar_1405807201.pdf)
   %(/Users/femfum/rar_1401573601.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/patufet_avuiFa100anys_19200410-23204.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/EnPatufet_any1_n1_19040103-9.pdf)

%(////)pstack quit
%   (/Users/femfum/Downloads/Descarregues/ARA/ara_1290898800_num1.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/8auricsHVgranFormat.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/8auricsV.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/8auricsH.pdf)
   %(/Users/femfum/PliegOS/codi_pliegOS/PDFscripting/8auricsHV.pdf)

   %% capturem la variable d'entorn que porta el nom del fitxer PDF normalitzat que s'ha carregat al servidor commonscloud.coop
   (MRCT_santSudari) getenv  %% la variable d'entorn existeix?
   {  
    dup length 0 eq
    {  %% arriba buida perquè executem via URL amb pliegOmaker.php sense paràmetres (mètode $_GET)
     pop true  %% si l'eliminem del menú via mètode $_POST també
    } 
    {  %% té dades perquè executem via URL amb index_##.php (mètode $_POST) o amb pliegOmaker.php amb paràmetres (mètode $_GET)
%%URLREpublica farcim el path absolut al PDF a imposar
(/var/www/wordpress/maker/REpublica/Hpdf/) /serverPath exch def
     dup length serverPath length add string dup 0 serverPath putinterval dup 3 -1 roll serverPath length exch putinterval
     %% és una string!
    }ifelse 
   }
   {  %% la variable d'entorn NO existeix perquè executem l'applet en local via Terminal per línia de comanda
    CddVf
    {
   %  false  %% fem visible la vora de la pàgina del llançat? (imposició) més endavant podrem posar-ho en una capa
    }       
    {
%    (ETSAQUIQUANEXECUTOALTERMINAL?)pstack quit	    
%     true   
%%URLUBESH
%% nom del PDF que hem d'imposar
%(OJUmesD9milCapes.pdf)
%(8paginesAmbAnotacions.pdf)
%(pdfreference1.7old.pdf)  %% duu bookmarks
%(8CropBox.pdf)
(8CropBox_MediaBox_CropBox_NOMESaLarrelPage_pla.pdf)

(/home/femfum/Documents/pliegOMakerUB/Hpdf/)  %% path absolut del fitxer a processar a Tuxedo
     /serverPath exch def
     dup length serverPath length add string dup 0 serverPath putinterval dup 3 -1 roll serverPath length exch putinterval
    }ifelse
    %% (\n Ghostscript no pot capturar aquesta variable d'entorn!\n\n)print flush
   }ifelse

%%REpublica a CaLi2CoPi
%%UBESH
%AVEUREQUINPATH
   /aCaLi2CoPi exch def

gsave
%%URLREpublica amb un path absolut
%(/var/www/wordpress/maker/REpublica/FemFum_CaLi2CoPi_042_REpublica.ps)
%%URLUBESH
(/home/femfum/Documents/pliegOMakerUB/FemFum_CaLi2CoPi_042_pliegOMakerUBESH.ps)
(r) file cvx exec
grestore

%%REpublica cal retornar el nom del PDF repicat per CaLi2CoPi
%%URLUBESH
bateiG
%(UUUIIII)pstack quit
   /pedeefa exch def

   %1% deixa una instància oberta a memòria sense cap objecte a l'stack que permet anar interrogant
   pedeefa (r) file dup /elF exch def runpdfbegin  %% cal tancar-la amb runpdfend al final

   %3% inicialitzem per intervenir dins l'estructura del pdf, afegint noves branques de dades, com la dels formularis
   /Context1 .PDFInit def
   pedeefa Context1 .PDFFile

   Context1 .PDFInfo /NumPages get /pAimposar exch def  %% nombre de pàgines a imposar del PDF a incrustar
   %% aquí podem treure conclusions de si l' M2, pel pliegOS escollit, podrem fer el llançat de totes les pàgines
   %% si en quedaran de buides a pliegOS (EP! n'hi pot haver de forçades) o si no les podrem imposar totes
  }if  %% un cop!

}ifelse  %% dos mètodes de lectura

%gsave

{  %% stopped

 MdL
 {
  1 pdfgetpage dup /Pdict exch def
 }
 {  %2% interroguem el MediaBox i el deixa a l'stack
  Npgn  %cvx exec

%%Un truc per començar més enllà de la pàgina 1 del PDF
%4 add

%  pdfgetpage dup /Pdict exch def
 }ifelse

%%Hem detectat que en el llançat de PDFs que duen la clau /CropBox manen per sobre del comportament de /MediaBox al full d'imposició
%% anul·lant-la i aplicant el valor de la darrera pàgina que es llança ...de fet el /CropBox sempre mana sobre el /MediaBox
%% el problema està que dins el context de la imposició no queda blindat i actua sobre el /MediaBox del full (una consulta a gs-devel?)
%% llavors, abans d'anul·lar-lo, l'interroguem per saber si és ídem al /MediaBox de la pàgina que llancem dins l'nUp doncs, en cas de no ser igual
%% li haurem de corregir el seu posicionat LL activant un rectclip afegit que encaixi dins el LL/UR i redimensionat-lo dins el format de pàgina de l'nUP
%% ...com sigui, hem vist que via PDF scripting NO podem anar més enllà de la interrogació de dades doncs no ens permet modificar el contingut de diccionaris o streams
%% del PDF que estem llançant, just abans de pintar-lo, per aquest motiu hem d'executar CaLi2CoPi abans i filtrar/modificar el necessari
%% per exemple: hem de permetre imposar PDFs encriptats? signats? 

%pop
%dup /CropBox undef  %% de moment no en fa cas

%% aquesta interrogació directe pot fallar (veure 8CropBox_MediaBox_CropBox_NOMESaLarrelPage_pla.pdf) i necessitaria un loop ascendent per l'arbre de pàgines
%% doncs no podem assegurar que /MediaBox estigui al diccionari /Page degut a que és un valor que (com /CropBox) es pot heretar de més enrera o de l'arrel /Pages
% /MediaBox get  %% de la primera pàgina (no és un índex i per tant comença per 1!)
%2 pdfgetpage /MediaBox get  %% de la segona, etc

%% aquest valor ja l'haurem analitzat a FemFum_CaLi2CoPi_042_pliegOMakerUBESH.ps que és on hi tenim la rutina que explora l'arbre de pàgines eficientment 
%% caldrà saber si hem de fer cas al valor de CropBox, en cas que sigui diferent de MediaBox, i n'hi haurà prou en haver-lo eliminat
%% o haurem d'adaptar-nos al retall de CropBox activant un rectclip amb translació+escala

%%UBESH
%% primer ens cal saber per %MENU% si hem de respectar el /CropBox en cas que existeixi
%% segon ens cal saber si MediaBox i CropBox (si existeix) són idèntics
%% si no ho són hem d'engegar l'operativa per moure i fer el rectclip de l'àrea del /CropBox que ha de fer de /araMediaBox 
%% si ho són no fem res i ja és bo el valor de /MediaBox
aMESaMES 0 eq
{  %% explorem  els valors de les àrees desades
 XRay /PeDeEfa get exch  get
 {
== ==
 }forall
(* * * * *)pstack quit
}if

(<<<<?)pstack quit
/araMediaBox exch def

%%TEST
%/Rotate get 0 ne
%{(<<< NOZERO)pstack quit}if

 %% deducció de l'escala de treball per adaptar al màxim cada pàgina del PDF que llegim a la pàgina del llançat
 %% es podria optar també per igualar els amples o alts de les pàgines que llegim al format de pàgina del llançat
 %% vegeu: igualatPerLaXmesAmplePossible.pdf i igualatPerLaYmesAltaPossible.pdf llegint 8auricsH.pdf i 8auricsV.pdf
 %% calculem el format de pàgina a partir del MediaBox de la pàgina que llegim
 araMediaBox aload pop 3 -1 roll sub abs exch 3 -1 roll sub abs exch  %% cal treballar amb el valor absolut!
 2 copy /YaImposar exch def /XaImposar exch def
 2 copy ge  %% el costat més gran o igual (quadrat) de la pàgina que llegim
 {  %% orientació horitzontal de la pàgina a imposar: l' X és el costat més gran
  /Odivisor false def
 }
 {  %% orientació vertical de la pàgina a imposar: l' Y és el costat més gran
  /Odivisor true def
 }ifelse
 %% el costat més gran de la pàgina del llançat
 xPagina yPagina gt
 {  %% l'orientació del llançat és horitzontal
(oH CAL afinar l'escala com %%+)pstack stop
  Odivisor
  {  %% però l'orientació de la pàgina a imposar és vertical
   exch pop yPagina exch div  %% escala de treball
  }
  {  %% però l'orientació de la pàgina a imposar és horitzontal
   pop xPagina exch div  %% escala de treball
  }ifelse
 }
 {  %% l'orientació del llançat és vertical
  Odivisor
  {  %% i l'orientació de la pàgina a imposar també és vertical
   exch pop yPagina exch div  %% escala de treball
%%+ ens cal saber si aquesta escala no fa que l'ample de la pàgina imposada superi encara la que disposa el llançat
   dup XaImposar mul xPagina 2 copy gt
   {  %% corregim l'escala, doncs l'X encara NO encaixa dins la pàgina del llançat
    XaImposar div  %% escala corregida
    exch pop exch pop
   }
   {
(NO hem de corregir l'escala)==  %pstack quit
pop pop
   }ifelse
  }
  {  %% però l'orientació de la pàgina a imposar és horitzontal
   pop xPagina exch div  %% escala de treball
%%REpublica: abans activavem un error però creiem que NO ho es doncs es tractaria d'una pagina completament quadrada
%(oV CAL afinar l'escala com %%+)pstack stop
  }ifelse
 }ifelse

 dup scale  %% adapta al màxim cada pàgina del PDF que llegim dins la pàgina del llançat
%% ídem si escalem via matriu
%[ exch 0 0 2 index 0 0 ] concat

 MdL
 {

%%TEST
%pedeefa Context1 .PDFStream
%(<<<<)pstack
%%Brossa d'un diccionari Info?
%{== ==}forall %(<<<<)pstack
% quit

  %%Pàgina -1 com a índex
  Context1 0 .PDFDrawPage  %% repiquem la pàgina Npgn però cridada com a índex
%  Context1 .PDFClose
%  runpdfend
%  elF closefile

 }
 { %% primer mètode de pintar la pàgina

%%Pàgina Npgn -1 com a índex
   Context1 Npgn cvx exec
%%Un truc per començar més enllà de la pàgina 1 del PDF
%4 add

   1 sub

%%NOVA metode per eliminar el /CropBox?
%%   Context1 1 index .PDFPageInfo /CropBox undef  %% NO rutlla


   .PDFDrawPage  %% repiquem la pàgina Npgn però cridada com a índex


%grestore

  %% segon mètode per pintar la pàgina
  % Pdict  %{== ==}forall (||||)== quit  %% pdfshowpage

%  Context1 .PDFClose
%  runpdfend

%  elF closefile

%%EP no ajuda a millorar?
%initgraphics
%initmatrix
%grestoreall
 }ifelse

}stopped
{
 (\n\n >>> ON PETES?\n\n) print flush (- - - - - - - - - -)pstack stop
}if

}if  %% noNULL anellem el codi sencer perquè no és aleatori per pàgina

